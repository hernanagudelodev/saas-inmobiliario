{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}Registrar Contrato Existente{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px;">
  <div class="card shadow-sm mt-4">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0"><i class="bi bi-file-earmark-arrow-up"></i> Registrar Contrato Existente</h4>
      <p class="mb-0 small">Para la propiedad: {{ propiedad.direccion }}</p>
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        <p class="alert alert-info">Usa este formulario solo para registrar contratos que ya están firmados y vigentes (migrados).</p>
        
        <div class="row">
          <fieldset class="col-md-6 border-end">
            <legend class="fs-5 fw-bold">1. Datos Generales y Propietario</legend>
            
            {% for field in form %}
              {# AÑADIDOS: periodicidad y uso_inmueble a la lista de este fieldset #}
              {% if field.name == 'propietario' or field.name == 'cuenta_bancaria_pago' or field.name == 'porcentaje_comision' or field.name == 'periodicidad' or field.name == 'uso_inmueble' %}
                <div class="mb-3">
                  <label for="{{ field.id_for_label }}" class="form-label fw-bold">{{ field.label }}</label>
                  {% if field|widget_type == 'select' %}
                    {{ field|add_class:"form-select" }}
                  {% else %}
                    {{ field|add_class:"form-control" }}
                  {% endif %}
                  {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                  {% if field.errors %}<div class="text-danger small">{{ field.errors|striptags }}</div>{% endif %}
                </div>
              {% endif %}
            {% endfor %}
          </fieldset>
          
          <fieldset class="col-md-6">
            <legend class="fs-5 fw-bold">2. Datos del Arrendatario</legend>
            {% for field in form %}
              {% if field.name == 'arrendatario' or field.name == 'codeudores' or field.name == 'valor_canon' %}
                {# ... (este bloque sigue igual) ... #}
                <div class="mb-3">
                  <label for="{{ field.id_for_label }}" class="form-label fw-bold">{{ field.label }}</label>
                  {% if field|widget_type == 'select' %}
                    {{ field|add_class:"form-select" }}
                  {% elif field|widget_type == 'selectmultiple' %}
                     {{ field|add_class:"form-select" }}
                  {% else %}
                    {{ field|add_class:"form-control" }}
                  {% endif %}
                  {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                  {% if field.errors %}<div class="text-danger small">{{ field.errors|striptags }}</div>{% endif %}
                </div>
              {% endif %}
            {% endfor %}
          </fieldset>
        </div>

        {# ... (resto del formulario: fieldset 3 y botones, sin cambios) ... #}
        <fieldset class="mt-3 border-top pt-3">
            <legend class="fs-5 fw-bold">3. Vigencia y Documento</legend>
             <div class="row">
                {% for field in form %}
                  {% if field.name == 'fecha_inicio_vigencia' or field.name == 'fecha_fin_vigencia' or field.name == 'archivo_pdf_firmado' %}
                    <div class="col-md-6 mb-3">
                      <label for="{{ field.id_for_label }}" class="form-label fw-bold">{{ field.label }}</label>
                      {% if field|widget_type == 'clearablefileinput' %}
                        {{ field|add_class:"form-control" }}
                      {% else %}
                        {{ field|add_class:"form-control" }}
                      {% endif %}
                      {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                      {% if field.errors %}<div class="text-danger small">{{ field.errors|striptags }}</div>{% endif %}
                    </div>
                  {% endif %}
                {% endfor %}
             </div>
        </fieldset>

        <button type="submit" class="btn btn-success mt-3">
          <i class="bi bi-check-circle"></i> Guardar Contrato Vigente
        </button>
        <a href="{% url 'core_inmobiliario:detalle_propiedad' propiedad.id %}" class="btn btn-link mt-3">Cancelar</a>
      </form>
    </div>
  </div>
</div>
{% endblock %}