{% extends "base.html" %}

{% block title %}Detalle de {{ propiedad.direccion }}{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1000px;">
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      <h3 class="mb-0"><i class="bi bi-building"></i> {{ propiedad.direccion }}</h3>
    </div>
    <div class="card-body">
      <ul class="list-group list-group-flush mb-3">
        <li class="list-group-item"><strong>Ciudad:</strong> {{ propiedad.ciudad }}</li>
        <li class="list-group-item"><strong>Tipo de Propiedad:</strong> {{ propiedad.tipo_propiedad }}</li>
        <li class="list-group-item"><strong>Matrícula Inmobiliaria:</strong> {{ propiedad.matricula_inmobiliaria|default:"–" }}</li>
      </ul>

      {% if propiedad.latitude and propiedad.longitude %}
        <div class="mb-3">
          <label class="form-label fw-bold">Ubicación en el Mapa</label>
          <div id="mapa-propiedad-{{ propiedad.id }}" style="width: 100%; min-height: 250px; height: 35vw; max-height: 400px; border-radius: 12px; box-shadow: 0 2px 8px #0002;"></div>
        </div>
      {% endif %}

      <a href="{% url 'core_inmobiliario:actualizar_propiedad' propiedad.id %}" class="btn btn-outline-primary btn-sm me-2">
        <i class="bi bi-pencil"></i> Editar Propiedad
      </a>
    </div>
  </div>

  <div class="card mb-4 shadow-sm">
  <div class="card-header">
    <h4 class="mb-0"><i class="bi bi-people"></i> Clientes Asociados a la Propiedad</h4>
  </div>
  <div class="card-body p-3">
    <div class="list-group list-group-flush mb-2">
      {% for rel in relaciones_clientes %}
        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
          <div class="flex-grow-1">
            <strong>{{ rel.cliente.nombre }}</strong>
          </div>
          <div class="flex-shrink-0 ms-3">
            <span class="badge bg-secondary">{{ rel.get_relacion_display }}</span>
          </div>
          <div class="flex-shrink-0 ms-3">
            <form action="{% url 'core_inmobiliario:eliminar_relacion_propiedad' rel.id %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Estás seguro?');">
                  <i class="bi bi-trash"></i>
                </button>
            </form>
          </div>
        </div>
      {% empty %}
        <p class="text-muted">Aún no hay clientes asociados a esta propiedad.</p>
      {% endfor %}
    </div>
    <a href="{% url 'core_inmobiliario:agregar_relacion_propiedad' propiedad.id %}" class="btn btn-outline-success btn-sm">
      <i class="bi bi-person-plus"></i> Añadir/Vincular Cliente
    </a>
    <a href="{% url 'core_inmobiliario:crear_cliente' %}" class="btn btn-outline-primary btn-sm">
      <i class="bi bi-plus-circle"></i> Crear Nuevo Cliente
    </a>
  </div>
</div>

  <div class="card shadow-sm">
    <div class="card-header">
      <h4 class="mb-0"><i class="bi bi-clipboard2-data"></i> Estado del Proceso de Alquiler</h4>
    </div>
    <div class="card-body">
      
      <div class="mb-3 p-3 border rounded {% if captacion_firmada %}border-success bg-success-subtle{% else %}border-warning bg-warning-subtle{% endif %}">
        <h5>
          {% if captacion_firmada %}
            <i class="bi bi-check-circle-fill text-success"></i> Etapa 1: Captación Completada
          {% else %}
            <i class="bi bi-exclamation-triangle-fill text-warning"></i> Etapa 1: Captación Pendiente
          {% endif %}
        </h5>
        {% if captacion_firmada %}
          <p class="mb-1">La propiedad ya cuenta con un inventario de captación firmado. Ya puedes proceder a crear los contratos.</p>
          <a href="{% url 'inventarioapp:resumen_formulario_captacion' captacion_firmada.id %}" class="btn btn-sm btn-outline-secondary">Ver Captación Firmada</a>
        {% else %}
          <p class="mb-1">El primer paso es registrar el inventario de captación y obtener la firma del propietario. Sin este paso, no se puede continuar.</p>
          <a href="{% url 'inventarioapp:crear_captacion' propiedad.id %}" class="btn btn-sm btn-primary">Crear Nueva Captación</a>
        {% endif %}
      </div>

      {% if captacion_firmada %}
        <div class="mb-3 p-3 border rounded {% if contrato_mandato.estado == 'VIGENTE' %}border-success bg-success-subtle{% else %}border-primary bg-primary-subtle{% endif %}">
          <h5>
            {% if contrato_mandato.estado == 'VIGENTE' %}
              <i class="bi bi-check-circle-fill text-success"></i> Etapa 2: Contratación Completada
            {% else %}
              <i class="bi bi-pencil-square text-primary"></i> Etapa 2: Contratación en Proceso
            {% endif %}
          </h5>

          {% if not contrato_mandato %}
            <p>El siguiente paso es crear el Contrato de Mandato con el propietario.</p>
            <a href="{% url 'gestion_arriendos:crear_contrato_mandato' propiedad.id %}" class="btn btn-sm btn-primary">Crear Contrato de Mandato</a>
          
          {% elif contrato_mandato and not contrato_arrendamiento %}
            <p class="mb-2">Ya existe un borrador del Contrato de Mandato. Puedes revisarlo o proceder a crear el Contrato de Arrendamiento.</p>
            <ul class="list-unstyled mb-2">
              <li>
                <strong>Contrato de Mandato:</strong> {{ contrato_mandato.get_estado_display }}
                <a href="{% url 'gestion_arriendos:detalle_contrato_mandato' contrato_mandato.id %}" class="ms-2">
                  <i class="bi bi-eye"></i> Ver Detalle
                </a>
              </li>
            </ul>
            <a href="{% url 'gestion_arriendos:crear_contrato_arrendamiento' contrato_mandato.id %}" class="btn btn-sm btn-primary">
              Crear Contrato de Arrendamiento
            </a>
          {% else %} <p>Ambos contratos han sido creados. Revisa sus estados y procede con la siguiente acción.</p>
            <ul class="list-unstyled">
              <li><strong>Contrato de Mandato:</strong> {{ contrato_mandato.get_estado_display }} <a href="{% url 'gestion_arriendos:detalle_contrato_mandato' contrato_mandato.id %}" class="ms-2">Ver Detalle</a></li>
              <li><strong>Contrato de Arrendamiento:</strong> {{ contrato_arrendamiento.get_estado_display }} <a href="{% url 'gestion_arriendos:detalle_contrato_arrendamiento' contrato_arrendamiento.id %}" class="ms-2">Ver Detalle</a></li>
            </ul>
            
            {% if contrato_mandato.estado == 'BORRADOR' and contrato_arrendamiento.estado == 'BORRADOR' %}
              <a href="{% url 'gestion_arriendos:enviar_ciclo_a_firmas' propiedad.id %}" class="btn btn-sm btn-success">
                  <i class="bi bi-send"></i> Enviar a Firmas
              </a>
              {% if contrato_mandato %}
              <div class="mt-3">
                  <a href="{% url 'gestion_arriendos:eliminar_proceso_borrador' propiedad.id %}" class="btn btn-sm btn-outline-danger">
                      <i class="bi bi-trash"></i> Eliminar Proceso en Borrador
                  </a>
              </div>
              {% endif %}
            {% elif contrato_mandato.estado == 'EN_FIRMAS' %}
              <button class="btn btn-sm btn-info disabled">Confirmar Firmas (Próximamente)</button>
              <button class="btn btn-sm btn-outline-secondary disabled">Revertir a Borrador (Próximamente)</button>
            {% endif %}
          {% endif %}
        </div>
      {% endif %}

      {% if contrato_mandato.estado == 'VIGENTE' and contrato_arrendamiento.estado == 'VIGENTE' %}
        <div class="p-3 border rounded {% if entrega_firmada %}border-success bg-success-subtle{% else %}border-danger bg-danger-subtle{% endif %}">
          <h5>
            {% if entrega_firmada %}
              <i class="bi bi-check-circle-fill text-success"></i> Etapa 3: Entrega Completada
            {% else %}
              <i class="bi bi-exclamation-triangle-fill text-danger"></i> Etapa 3: Inventario de Entrega ¡PENDIENTE!
            {% endif %}
          </h5>

          {% if entrega_firmada %}
            <p>La propiedad ya fue entregada formalmente al arrendatario.</p>
            <a href="#" class="btn btn-sm btn-outline-secondary disabled">Ver Entrega Firmada</a>
          {% else %}
            <p class="fw-bold">Es crítico realizar el inventario de entrega y obtener la firma del arrendatario para formalizar la entrega del inmueble.</p>
            <a href="#" class="btn btn-sm btn-danger">Crear Inventario de Entrega</a>
          {% endif %}
        </div>
      {% endif %}

    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  
  {% if propiedad.latitude and propiedad.longitude %}
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // Usamos .replace para asegurar que los decimales con coma funcionen
        const lat = parseFloat('{{ propiedad.latitude|stringformat:".6f" }}'.replace(',', '.'));
        const lng = parseFloat('{{ propiedad.longitude|stringformat:".6f" }}'.replace(',', '.'));

        if (!isNaN(lat) && !isNaN(lng)) {
          const mapDivId = 'mapa-propiedad-{{ propiedad.id }}';
          const map = L.map(mapDivId).setView([lat, lng], 16);
          
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
          }).addTo(map);
          
          L.marker([lat, lng]).addTo(map);
        }
      });
    </script>
  {% endif %}
{% endblock %}